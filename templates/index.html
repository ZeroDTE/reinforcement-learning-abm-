<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ABM: DQN vs Heuristic agents </title>
    <style>
        body { margin: 0; background-color: #1e1e1e; color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #game-container { flex: 3; display: flex; justify-content: center; align-items: center; background: #111; position: relative;}
        #sidebar { flex: 1; background-color: #2d2d2d; padding: 20px; border-left: 2px solid #444; display: flex; flex-direction: column; min-width: 320px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); overflow-y: auto; }

        canvas { background-color: #1e1e1e; border: 2px solid #555; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 90vh; max-width: 90vh; }

        h1 { color: #ffd700; margin-top: 0; font-size: 22px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        h3 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 15px; color: #aaa; font-size: 14px; text-transform: uppercase; }
        
        .control-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 13px; color: #ccc; }
        select, input[type="number"] { width: 100%; padding: 6px; background: #444; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box;}
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; text-transform: uppercase; font-size: 12px;}
        .btn-apply { background: #4caf50; color: white; }
        .btn-apply:hover { background: #45a049; }
        .btn-toggle { background: #2196f3; color: white; }
        .btn-toggle:hover { background: #1976d2; }

        #leaderboard { margin-top: 10px; background: #222; border-radius: 4px; overflow: hidden; }
        .agent-row { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #333; align-items: center; font-size: 13px; }
        .agent-name { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid rgba(255,255,255,0.3); }
        .agent-score { font-family: monospace; font-size: 14px; color: #ffd700; }

        .stat-box { display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px; color: #eee; background: #333; padding: 8px; border-radius: 4px;}
        .status-msg { text-align: center; margin-top: 10px; font-weight: bold; min-height: 20px; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gridCanvas" width="800" height="800"></canvas>
    </div>

    <div id="sidebar">
        <h1>üèÅ AI GridWorld Showdown</h1>
        
        <h3>Simulation Config</h3>
        <div class="control-group">
            <label>choose Model (Red Agent)</label>
            <select id="modelSelect">
                <option value="cost">Model:Minimize Cost (Safe/Efficient)</option>
                <option value="profit">Model:Maximize Profit (Greedy)</option>
            </select>
        </div>

        <div class="control-group">
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="bfsCheck" style="width:auto;">
                <label style="margin:0; cursor:pointer;" for="bfsCheck">Add BFS (White)</label>
            </div>
        </div>

        <div class="control-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Step Penalty</label>
                    <input type="number" id="penaltyInput" value="-2.0" step="0.1" max="0">
                </div>
                <div style="flex:1">
                    <label>Max Steps</label>
                    <input type="number" id="maxStepsInput" value="250" step="10" min="50">
                </div>
            </div>
        </div>
        <div class="control-group">
            <label>Resource Count</label>
            <input type="number" id="resInput" value="150" step="10" min="10" max="500">
        </div>

        <div class="btn-row">
            <button class="btn-apply" onclick="applySettings()">üîÑ Apply & Reset</button>
        </div>
        <div class="btn-row">
            <button class="btn-toggle" onclick="togglePause()" id="pauseBtn">‚ñ∂ START / PAUSE</button>
        </div>

        <h3>Live Ranking</h3>
        <div id="leaderboard"></div>

        <h3>Stats</h3>
        <div class="stat-box">
            <span>Resources Left:</span> <span id="resCount">0</span>
        </div>
        <div class="stat-box">
            <span>Steps:</span> <span id="stepCount">0 / 0</span>
        </div>
        <div id="gameStatus" class="status-msg" style="color: #ffd700;"></div>
    </div>

    <script>
        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');
        const cellSize = 20; 

        async function updateLoop() {
            try {
                const response = await fetch('/step');
                const data = await response.json();
                
                if(!data.error) {
                    draw(data);
                    updateUI(data);
                }
            } catch (e) { console.error(e); }
            setTimeout(updateLoop, 40); 
        }

        function draw(data) {
            ctx.fillStyle = "#222";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Obstacles
            ctx.fillStyle = "#555";
            data.grid.forEach(obj => {
                if(obj.t === 1) ctx.fillRect(obj.y*cellSize, obj.x*cellSize, cellSize, cellSize);
            });

            // Resources (Gold with shine)
            data.grid.forEach(obj => {
                if(obj.t === 2) {
                    const cx = obj.y*cellSize + cellSize/2;
                    const cy = obj.x*cellSize + cellSize/2;
                    const grad = ctx.createRadialGradient(cx, cy, 2, cx, cy, 8);
                    grad.addColorStop(0, "#fff7cc");
                    grad.addColorStop(1, "#FFD700");
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(cx, cy, cellSize/3, 0, Math.PI*2);
                    ctx.fill();
                }
            });

            // Agents
            data.agents.forEach(ag => {
                if(!ag.active) return;
                ctx.fillStyle = ag.color;
                const x = ag.y * cellSize; 
                const y = ag.x * cellSize;
                ctx.fillRect(x+2, y+2, cellSize-4, cellSize-4);
                ctx.strokeStyle = "rgba(255,255,255,0.7)";
                ctx.lineWidth = 1;
                ctx.strokeRect(x+2, y+2, cellSize-4, cellSize-4);
            });
        }

        function updateUI(data) {
            document.getElementById('resCount').innerText = data.res_left;
            document.getElementById('stepCount').innerText = `${data.steps} / ${data.max_steps}`;
            
            const statusDiv = document.getElementById('gameStatus');
            if(data.game_over) {
                statusDiv.innerText = data.res_left === 0 ? "‚ú® CLEARED! ‚ú®" : "‚õî TIME'S UP";
                statusDiv.style.color = data.res_left === 0 ? "#4caf50" : "#ff5252";
            } else {
                statusDiv.innerText = "";
            }

            const lb = document.getElementById('leaderboard');
            lb.innerHTML = '';
            
            const sorted = data.agents.sort((a,b) => b.score - a.score);
            sorted.forEach(ag => {
                const div = document.createElement('div');
                div.className = 'agent-row';
                div.style.opacity = ag.active ? 1.0 : 0.4;
                div.innerHTML = `
                    <div class="agent-name">
                        <span class="color-dot" style="background:${ag.color}"></span>
                        ${ag.name} ${ag.active ? '' : '(EXIT)'}
                    </div>
                    <div class="agent-score">${ag.score.toFixed(1)}</div>
                `;
                lb.appendChild(div);
            });
        }

        async function applySettings() {
            const model = document.getElementById('modelSelect').value;
            const bfs = document.getElementById('bfsCheck').checked;
            const pen = document.getElementById('penaltyInput').value;
            const res = document.getElementById('resInput').value;
            const maxSteps = document.getElementById('maxStepsInput').value;

            await fetch('/reset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    model: model, 
                    use_bfs: bfs, 
                    penalty: pen, 
                    res: res,
                    max_steps: maxSteps
                })
            });
        }

        async function togglePause() { await fetch('/toggle', {method: 'POST'}); }

        updateLoop();
    </script>
</body>
</html>