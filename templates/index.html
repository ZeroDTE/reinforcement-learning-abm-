<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI GridWorld Simulation</title>
    <style>
        body { margin: 0; background-color: #1e1e1e; color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* LAYOUT */
        #game-container { flex: 3; display: flex; justify-content: center; align-items: center; background: #111; position: relative;}
        #sidebar { flex: 1; background-color: #2d2d2d; padding: 20px; border-left: 2px solid #444; display: flex; flex-direction: column; min-width: 300px; max-width: 400px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }

        /* CANVAS */
        canvas { background-color: #1e1e1e; border: 2px solid #555; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* CONTROLS */
        h1 { color: #ffd700; margin-top: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        h3 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 20px; color: #aaa; }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #ccc; }
        
        select, input[type="number"] { width: 100%; padding: 8px; background: #444; border: 1px solid #555; color: white; border-radius: 4px; }
        
        /* BUTTONS */
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; text-transform: uppercase;}
        
        .btn-apply { background: #4caf50; color: white; }
        .btn-apply:hover { background: #45a049; }
        
        .btn-toggle { background: #2196f3; color: white; }
        .btn-toggle:hover { background: #1976d2; }

        /* LEADERBOARD */
        #leaderboard { margin-top: 20px; background: #222; border-radius: 4px; overflow: hidden; }
        .agent-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .agent-name { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .agent-score { font-family: monospace; font-size: 16px; }

        /* STATS */
        .stat-box { display: flex; justify-content: space-between; margin-top: 10px; font-size: 18px; color: #ffd700; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gridCanvas" width="800" height="800"></canvas>
    </div>

    <div id="sidebar">
        <h1>AI Dashboard</h1>
        
        <h3>Simulation Config</h3>
        
        <div class="control-group">
            <label>AI Model Strategy</label>
            <select id="modelSelect">
                <option value="cost">Minimize Cost (Safe)</option>
                <option value="profit">Maximize Profit (Greedy)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Extra Agents</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="bfsCheck" style="width:auto;">
                <span>Include BFS Robot (Magenta)</span>
            </div>
        </div>

        <div class="control-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Penalty</label>
                    <input type="number" id="penaltyInput" value="-2.0" step="0.1">
                </div>
                <div style="flex:1">
                    <label>Resources</label>
                    <input type="number" id="resInput" value="150" step="10">
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn-apply" onclick="applySettings()">Apply & Reset</button>
        </div>
        
        <div class="btn-row">
            <button class="btn-toggle" onclick="togglePause()" id="pauseBtn">START / PAUSE</button>
        </div>

        <h3>Live Ranking</h3>
        <div id="leaderboard">
            </div>

        <div class="stat-box">
            <span>Resources Left:</span>
            <span id="resCount">0</span>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');
        const cellSize = 20; // 40x40 grid * 20px = 800px

        // Main Loop
        async function updateLoop() {
            try {
                const response = await fetch('/step');
                const data = await response.json();
                
                if(!data.error) {
                    draw(data);
                    updateUI(data);
                }
            } catch (e) { console.error(e); }
            
            // Loop speed (approx 20 FPS)
            setTimeout(updateLoop, 50); 
        }

        function draw(data) {
            // Clear
            ctx.fillStyle = "#303030";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Grid Lines (Subtle)
            ctx.strokeStyle = "#3a3a3a";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<=800; i+=cellSize) {
                ctx.moveTo(i,0); ctx.lineTo(i,800);
                ctx.moveTo(0,i); ctx.lineTo(800,i);
            }
            ctx.stroke();

            // Draw Obstacles (Grey Blocks)
            ctx.fillStyle = "#666";
            data.grid.forEach(obj => {
                if(obj.t === 1) ctx.fillRect(obj.y*cellSize, obj.x*cellSize, cellSize, cellSize);
            });

            // Draw Resources (Gold Circles)
            ctx.fillStyle = "#FFD700";
            data.grid.forEach(obj => {
                if(obj.t === 2) {
                    ctx.beginPath();
                    ctx.arc(obj.y*cellSize + cellSize/2, obj.x*cellSize + cellSize/2, cellSize/3, 0, Math.PI*2);
                    ctx.fill();
                }
            });

            // Draw Agents
            data.agents.forEach(ag => {
                if(!ag.active) return;
                
                ctx.fillStyle = ag.color;
                const x = ag.y * cellSize; // Flip logic: grid[row][col] -> x=col, y=row
                const y = ag.x * cellSize;
                
                // Agent Body
                ctx.fillRect(x+2, y+2, cellSize-4, cellSize-4);
                
                // Border
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2;
                ctx.strokeRect(x+2, y+2, cellSize-4, cellSize-4);
            });
        }

        function updateUI(data) {
            document.getElementById('resCount').innerText = data.res_left;
            
            const lb = document.getElementById('leaderboard');
            lb.innerHTML = '';
            
            // Sort by score
            const sorted = data.agents.sort((a,b) => b.score - a.score);
            
            sorted.forEach(ag => {
                const div = document.createElement('div');
                div.className = 'agent-row';
                div.style.opacity = ag.active ? 1.0 : 0.5;
                div.innerHTML = `
                    <div class="agent-name">
                        <span class="color-dot" style="background:${ag.color}"></span>
                        ${ag.name} ${ag.active ? '' : '(EXIT)'}
                    </div>
                    <div class="agent-score">${ag.score.toFixed(1)}</div>
                `;
                lb.appendChild(div);
            });
        }

        // Controls
        async function applySettings() {
            const model = document.getElementById('modelSelect').value;
            const bfs = document.getElementById('bfsCheck').checked;
            const pen = document.getElementById('penaltyInput').value;
            const res = document.getElementById('resInput').value;

            await fetch('/reset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ model: model, use_bfs: bfs, penalty: pen, res: res })
            });
        }

        async function togglePause() {
            await fetch('/toggle', {method: 'POST'});
        }

        // Start
        updateLoop();
    </script>
</body>
</html>